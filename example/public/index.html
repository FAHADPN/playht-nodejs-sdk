<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PlayHT API Examples</title>
  </head>
  <body>
    <h1>PlayHT API Examples</h1>

    <h2>Generate speech from text</h2>
    <div><label>Enter text to generate:</label></div>
    <div>
      <textarea id="textToGenerate">
Immersed in the text's pages, I journeyed through a world woven with words and imagination.</textarea
      >
    </div>
    <div><button onclick="generateClick()">Generate Audio</button></div>
    <audio id="audioPlayer" controls>Your browser does not support the audio element.</audio>
    <hr />
    <h2>Stream speech from text</h2>
    <div><label>Enter text to stream:</label></div>
    <div>
      <textarea id="streamTextToGenerate">
The clear, babbling stream meandered through the lush, sunlit meadow, creating a soothing and tranquil atmosphere.</textarea
      >
    </div>
    <div><button onclick="generateStreamClick()">Generate Audio</button></div>
    <audio id="streamAudioPlayer" controls>Your browser does not support the audio element.</audio>

    <script>
      function generateClick(event) {
        const text = document.getElementById('textToGenerate').value;
        requestGeneration('/textToSpeech', text, 'audioPlayer');
      }

      function generateStreamClick(event) {
        const text = document.getElementById('streamTextToGenerate').value;
        const searchParams = new URLSearchParams();
        searchParams.set('text', text);
        playUrl(`/streamSpeech?${searchParams.toString()}`, 'streamAudioPlayer');
      }

      function requestGeneration(apiURL, text, audioPlayerId) {
        const options = {
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            text,
          }),
          method: 'POST',
        };

        fetch(apiURL, options)
          .then((response) => {
            if (response.ok) {
              return response.json();
            } else {
              throw new Error(response.statusText);
            }
          })
          .then((json) => {
            const url = json?.url || Array.isArray(json?.audioUrl) ? json?.audioUrl?.[0] : json?.audioUrl;
            playUrl(url, audioPlayerId);
          })
          .catch((error) => {
            if (error.message) {
              alert(error.message);
            } else {
              alert('Error while contacting the API: ' + error);
            }
          });
        return true;
      }

      function playUrl(audioSourceUrl, audioElementId) {
        const audio = document.getElementById(audioElementId);

        audio.pause();
        audio.currentTime = 0;

        const existingSource = audio.querySelector('source');
        if (existingSource) {
          audio.removeChild(existingSource);
        }

        const source = document.createElement('source');
        source.src = audioSourceUrl;
        source.type = 'audio/mpeg';

        audio.appendChild(source);
        audio.load();

        audio.addEventListener('canplaythrough', () => {
          audio.play();
        });
      }
    </script>
  </body>
</html>
